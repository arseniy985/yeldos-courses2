<?php

namespace App\Http\Controllers\API;

use App\Http\Controllers\Controller;
use App\Services\AIServiceInterface;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use App\Models\Courses;

class CourseFinderController extends Controller
{
    private AIServiceInterface $aiService;

    /**
     * Промпт для поиска курсов
     */
    private static string $courseFinderPrompt = <<<PROMPT
    Сен — білім беру кеңесшісісің, ҚАТАҢ ШЕКТЕЛГЕН қолжетімді курстар тізімінен курстарды таңдауға көмектесесің.

    **ЕҢ МАҢЫЗДЫ ЕРЕЖЕ:**
    Сен ЕШҚАШАН, ЕШҚАНДАЙ ЖАҒДАЙДА курстар туралы ақпаратты ойдан шығармауың, өзгертпеуің немесе модификацияламауың керек.

    **Курс деректерінің форматы:**
    Әрбір курстың келесі өрістері бар:
    - id: бірегей идентификатор
    - name: курстың НАҚТЫ атауы
    - description: курстың НАҚТЫ сипаттамасы
    - instructor: оқытушының НАҚТЫ аты
    - rating: курс рейтингі
    - price: курс бағасы
    - episodes: курс эпизодтарының тізімі (бар болса)

    **МІNДЕТТІ ТАЛАПТАР:**
    1. ТЕК қана берілген JSON-массивтегі деректерді ҚОЛДАН
    2. ҚАТАҢ ТЫЙЫМ САЛЫНАДЫ:
       - Курс атауларын ойдан шығару
       - Оқытушылардың аттарын өзгерту
       - Курс сипаттамаларын өзгерту
       - Жоқ курстарды қосу
       - Бағаларды, рейтингтерді немесе басқа сипаттамаларды өзгерту
    3. Егер сұранысқа СӘЙКЕС курстар БОЛМАСА, шынымен айт: "Өкінішке орай, біздің базада сіздің сұранысыңызға сәйкес келетін курстар жоқ"
    4. ТЕК қана сұранысқа НАҚТЫ сәйкес келетін немесе сұралған тақырыппен тығыз байланысты курстарды ұсын
    5. ӘРҚАШАН атауды, оқытушының атын және басқа деректерді ДӘЛМЕ-ДӘЛ, өзгертпей көшір

    **Пайдаланушыға жауап:**
    - Сәлемдесу және қысқаша кіріспе
    - Сұранысқа сәйкес келетін ТЕК НАҚТЫ базадағы курстар тізімі
    - Әрбір курс үшін:
      * НАҚТЫ атауы (деректерден өзгертусіз көшірілген)
      * Оқытушы: НАҚТЫ аты (деректерден өзгертусіз көшірілген)
      * Толық сипаттама: description өрісінен алғашқы 100-150 таңба (егер ол үлкен болса)
      * Рейтинг: rating өрісінен нақты мән
      * Баға: price өрісінен нақты мән

    **МАҢЫЗДЫ ТЫЙЫМ:**
    БЕРІЛГЕН JSON-да ЖОҚ КУРСТАРДЫ ЕШҚАШАН ОЙДАН ШЫҒАРМА.
    Егер деректерде болмаса, "ұқсас" немесе "балама" курстарды ұсынба.
    Деректерде жоқ, бірақ сұранысқа "ұқсас естілетін" курс атауларын қолданба.

    **Пайдаланушы сұранысы:** {userQuery}

    ӨЗӨЗГЕЗІ МАҢЫЗДЫ: Келесі хабарлама қолжетімді курстар туралы ақпаратты қамтитын JSON-массив болады.
    ТЕК ОСЫ КУРСТАР БАР. Басқа курстар ЖОҚ және болуы мүмкін емес.
    ТЕК ОСЫ ДЕРЕКТЕРДІ ЖӘНЕ ЕШНӘРСЕ БАСҚА ҚОЛДАНБА.
    PROMPT;

    /**
     * Constructor with dependency injection
     */
    public function __construct(AIServiceInterface $aiService)
    {
        $this->aiService = $aiService;
    }

    /**
     * Обработка запроса пользователя на поиск подходящего курса
     */
    public function findCourse(Request $request): JsonResponse
    {
        $userQuery = $request->input('message');

        if (empty($userQuery)) {
            return response()->json([
                'success' => false,
                'message' => 'Өтінемін, оқу мақсаттарыңызды немесе қызығушылықтарыңызды көрсетіңіз'
            ], 400);
        }

        // Получаем все доступные курсы с эпизодами
        $courses = Courses::with('episodes')->get();

        if ($courses->isEmpty()) {
            return response()->json([
                'success' => true,
                'message' => 'Өкінішке орай, жүйеде әзірге қолжетімді курстар жоқ'
            ], 200);
        }

        // Формируем промпт с запросом пользователя
        $prompt = str_replace('{userQuery}', $userQuery, self::$courseFinderPrompt);

        // Получаем ответ от нейросети через абстрактный интерфейс
        $response = $this->aiService->query($prompt, json_encode($courses));

        return response()->json([
            'success' => true,
            'message' => urldecode(htmlspecialchars($response))
        ]);
    }
}
